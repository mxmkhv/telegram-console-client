{
  "project": "telegram-console",
  "branchName": "feature/media-display",
  "description": "Media Display Feature - Add image, sticker, and GIF display support with progressive disclosure UX",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add MediaAttachment type and extend Message interface",
      "description": "As a developer, I need type definitions for media attachments so TypeScript can validate media handling code.",
      "acceptanceCriteria": [
        "Add MediaType union: 'photo' | 'sticker' | 'gif' | 'video' | 'document'",
        "Add MediaAttachment interface with all fields from design spec",
        "Extend Message interface with optional media?: MediaAttachment field",
        "Typecheck passes: bun run typecheck"
      ],
      "passes": true,
      "notes": "File: src/types/index.ts"
    },
    {
      "id": "US-002",
      "title": "Add extractMedia function for GramJS messages",
      "description": "As a developer, I need to extract media metadata from GramJS Api.Message objects.",
      "acceptanceCriteria": [
        "Add extractMedia(msg: Api.Message): MediaAttachment | undefined function",
        "Correctly identifies photos from MessageMediaPhoto",
        "Correctly identifies stickers from DocumentAttributeSticker",
        "Correctly identifies GIFs from DocumentAttributeAnimated or video/mp4",
        "Extracts fileSize, width, height, mimeType, emoji, isAnimated fields",
        "Stores _message reference for later download",
        "Typecheck passes"
      ],
      "passes": true,
      "notes": "File: src/services/telegram.ts"
    },
    {
      "id": "US-003",
      "title": "Add downloadMedia method to telegram service",
      "description": "As a developer, I need to download media buffers from Telegram servers.",
      "acceptanceCriteria": [
        "Add downloadMedia(message: Message): Promise<Buffer | undefined> method",
        "Returns undefined if message has no media or _message reference",
        "Uses client.downloadMedia() to fetch buffer",
        "Typecheck passes"
      ],
      "passes": true,
      "notes": "File: src/services/telegram.ts"
    },
    {
      "id": "US-004",
      "title": "Install lru-cache dependency",
      "description": "As a developer, I need the lru-cache package for in-memory media caching.",
      "acceptanceCriteria": [
        "Run: bun add lru-cache",
        "Package added to package.json dependencies",
        "Typecheck passes"
      ],
      "passes": true,
      "notes": "Installed lru-cache@11.2.4"
    },
    {
      "id": "US-005",
      "title": "Create mediaCache service with LRU caching",
      "description": "As a developer, I need an in-memory cache to prevent re-downloading media when navigating messages.",
      "acceptanceCriteria": [
        "Create src/services/mediaCache.ts",
        "LRUCache with max 50 items, 100MB maxSize",
        "CachedMedia interface with buffer, inlinePreview, panelImage",
        "getMediaBuffer() with request deduplication via pendingDownloads Map",
        "getCachedInlinePreview() and setCachedInlinePreview()",
        "getCachedPanelImage() and setCachedPanelImage()",
        "clearCache() function",
        "Typecheck passes"
      ],
      "passes": true,
      "notes": "Key optimization: pendingDownloads Map prevents duplicate concurrent downloads"
    },
    {
      "id": "US-006",
      "title": "Install terminal-image dependency",
      "description": "As a developer, I need the terminal-image package to render images as ANSI blocks.",
      "acceptanceCriteria": [
        "Run: bun add terminal-image",
        "Package added to package.json dependencies",
        "Typecheck passes"
      ],
      "passes": true,
      "notes": "Installed terminal-image@4.2.0"
    },
    {
      "id": "US-007",
      "title": "Create imageRenderer service with rendering utilities",
      "description": "As a developer, I need wrapper functions for terminal-image to render at different sizes.",
      "acceptanceCriteria": [
        "Create src/services/imageRenderer.ts",
        "renderImageBuffer(buffer, options) with width/height/preserveAspectRatio",
        "renderInlinePreview(buffer) with height: 5",
        "renderPanelImage(buffer, panelWidth) with 90% width",
        "formatBytes() with memoization cache",
        "formatMediaMetadata(media, messageId) with memoization cache",
        "capitalize() helper function",
        "Typecheck passes"
      ],
      "passes": true,
      "notes": "Use direct imports from terminal-image to minimize bundle impact"
    },
    {
      "id": "US-008",
      "title": "Add mediaPanel state and actions to reducer",
      "description": "As a developer, I need state management for the media panel and inline previews.",
      "acceptanceCriteria": [
        "Add mediaPanel state: { isOpen, messageId, loading, imageData, error }",
        "Add inlinePreviews Map state for per-message preview data",
        "Add OPEN_MEDIA_PANEL action",
        "Add CLOSE_MEDIA_PANEL action",
        "Add SET_MEDIA_LOADING action",
        "Add SET_MEDIA_DATA action",
        "Add SET_MEDIA_ERROR action",
        "Add SET_INLINE_PREVIEW_LOADING action",
        "Add SET_INLINE_PREVIEW_DATA action",
        "Add SET_INLINE_PREVIEW_ERROR action",
        "Typecheck passes"
      ],
      "passes": true,
      "notes": "File: src/state/reducer.ts"
    },
    {
      "id": "US-009",
      "title": "Create MediaPlaceholder component",
      "description": "As a user, I want to see media type and size at a glance without downloading.",
      "acceptanceCriteria": [
        "Create src/components/MediaPlaceholder.tsx",
        "Displays formatted metadata: [ðŸ“· Photo: 1.2MB, 1920x1080]",
        "Uses formatMediaMetadata from imageRenderer",
        "Memoized with React.memo()",
        "Typecheck passes"
      ],
      "passes": true,
      "notes": "Icons: ðŸ“· photo, ðŸ˜€ sticker, ðŸŽ¬ gif, ðŸŽ¥ video, ðŸ“„ document, ðŸŽ­ animated"
    },
    {
      "id": "US-010",
      "title": "Create MediaPreview component with cache integration",
      "description": "As a user, I want to see a small inline preview when I select a media message.",
      "acceptanceCriteria": [
        "Create src/components/MediaPreview.tsx",
        "Checks cache synchronously on render (no flicker on cache hit)",
        "200ms debounce before starting download (prevents spam on rapid j/k navigation)",
        "Cancel pending debounced download when selection changes (cleanup function)",
        "Shows 'Loading preview...' during download",
        "Downloads via getMediaBuffer with deduplication",
        "Renders via renderInlinePreview (height: 5)",
        "Caches rendered preview via setCachedInlinePreview",
        "Memoized with React.memo()",
        "Handles cleanup on unmount (cancelled flag + clearTimeout)",
        "Typecheck passes"
      ],
      "passes": true,
      "notes": "Scope: ALL non-animated media (photos, static stickers, GIF thumbnails). Uses useInput per component pattern."
    },
    {
      "id": "US-011",
      "title": "Integrate media extraction into message fetching",
      "description": "As a developer, I need messages to include extracted media when fetched from Telegram.",
      "acceptanceCriteria": [
        "Modify message mapping in telegram service to call extractMedia()",
        "Messages with media include populated MediaAttachment",
        "Messages without media have media: undefined",
        "Typecheck passes"
      ],
      "passes": true,
      "notes": "File: src/services/telegram.ts - added extractMedia() call to getMessages and onNewMessage handler"
    },
    {
      "id": "US-012",
      "title": "Update MessageView to show MediaPlaceholder",
      "description": "As a user, I want to see media placeholders in the message list.",
      "acceptanceCriteria": [
        "Import MediaPlaceholder component",
        "Render MediaPlaceholder below message text when msg.media exists",
        "Update getMessageLineCount to add 1 line for placeholder",
        "Typecheck passes",
        "Verify visually: messages with media show [ðŸ“· Photo: ...] placeholder"
      ],
      "passes": true,
      "notes": "File: src/components/MessageView.tsx"
    },
    {
      "id": "US-013",
      "title": "Update MessageView to show MediaPreview when selected",
      "description": "As a user, I want to see an inline preview when I navigate to a media message.",
      "acceptanceCriteria": [
        "Import MediaPreview component",
        "Render MediaPreview when message is selected AND has non-animated media",
        "Update getMessageLineCount to add 6 lines for preview when selected",
        "Typecheck passes",
        "Verify visually: selecting media message shows inline preview below placeholder"
      ],
      "passes": true,
      "notes": "File: src/components/MessageView.tsx"
    },
    {
      "id": "US-014",
      "title": "Create MediaPanel component",
      "description": "As a user, I want to see a full-size image in a side panel when I press Enter.",
      "acceptanceCriteria": [
        "Create src/components/MediaPanel.tsx",
        "Shows loading state while downloading",
        "Shows error state on failure",
        "Renders full image using renderPanelImage",
        "Shows metadata footer: Photo â€¢ 1.2MB â€¢ 1920x1080",
        "Shows hint: Enter/Esc to close",
        "Uses cache: getCachedPanelImage/setCachedPanelImage",
        "Handles keyboard: Enter or Escape closes panel",
        "Typecheck passes"
      ],
      "passes": true,
      "notes": "Panel takes ~40% width, positioned on right side"
    },
    {
      "id": "US-015",
      "title": "Add Enter key handler to open MediaPanel",
      "description": "As a user, I want to press Enter on a media message to open the full view panel.",
      "acceptanceCriteria": [
        "MessageView handles Enter key on selected message",
        "If selected message has media: dispatch OPEN_MEDIA_PANEL",
        "If no media: existing behavior (if any)",
        "Typecheck passes"
      ],
      "passes": false,
      "notes": "File: src/components/MessageView.tsx"
    },
    {
      "id": "US-016",
      "title": "Update App layout to include MediaPanel",
      "description": "As a user, I want to see the media panel appear alongside the message list.",
      "acceptanceCriteria": [
        "Import MediaPanel component",
        "Conditionally render MediaPanel when state.mediaPanel.isOpen",
        "MediaPanel takes ~40% width on right side",
        "MessageView flexGrow shrinks to accommodate panel",
        "Focus moves to MediaPanel when opened",
        "Focus returns to MessageView when closed",
        "Typecheck passes",
        "Verify visually: pressing Enter on media opens side panel"
      ],
      "passes": false,
      "notes": "File: src/components/App.tsx"
    },
    {
      "id": "US-017",
      "title": "Handle panel close with Enter/Escape keys",
      "description": "As a user, I want to close the media panel by pressing Enter or Escape.",
      "acceptanceCriteria": [
        "MediaPanel handles Enter key: dispatch CLOSE_MEDIA_PANEL",
        "MediaPanel handles Escape key: dispatch CLOSE_MEDIA_PANEL",
        "Focus returns to MessageView after close",
        "Typecheck passes",
        "Verify visually: pressing Escape closes panel and returns to message list"
      ],
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "End-to-end verification of media display flow",
      "description": "As a developer, I need to verify the complete media display feature works correctly.",
      "acceptanceCriteria": [
        "Open a chat with media messages",
        "Verify placeholders show for all media (photos, stickers, GIFs)",
        "Navigate to a photo message with j/k keys",
        "Verify inline preview appears when selected",
        "Press Enter to open panel",
        "Verify full image renders in panel",
        "Press Escape to close panel",
        "Verify focus returns to message list",
        "Navigate away and back to same message",
        "Verify cache hit (no loading state)",
        "Typecheck passes"
      ],
      "passes": false,
      "notes": "Manual testing with real Telegram account"
    }
  ]
}
